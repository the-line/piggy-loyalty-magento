<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <!-- Interface preferences -->
    <preference for="Leat\Loyalty\Model\RateLimiterInterface" type="Leat\Loyalty\Model\RateLimiter" />
    <preference for="Leat\Loyalty\Api\ApplyBalanceInterface" type="Leat\Loyalty\Model\ApplyBalance" />
    <preference for="Leat\Loyalty\Api\ApplyGiftCardInterface" type="Leat\Loyalty\Model\ApplyGiftCard" />
    <preference for="Leat\Loyalty\Api\Data\ApplyBalanceResultInterface" type="Leat\Loyalty\Model\Data\ApplyBalanceResult" />
    <preference for="Leat\Loyalty\Api\Data\ApplyGiftCardResultInterface" type="Leat\Loyalty\Model\Data\ApplyGiftCardResult" />
    <preference for="Leat\Loyalty\Api\BalanceValidatorInterface" type="Leat\Loyalty\Model\BalanceValidator" />
    <preference for="Leat\Loyalty\Api\OrderLeatBalanceRepositoryInterface" type="Leat\Loyalty\Model\Order\LeatBalanceRepository" />
    <preference for="Leat\Loyalty\Api\PrepaidTransactionServiceInterface" type="Leat\Loyalty\Model\PrepaidTransactionService" />
    <preference for="Leat\Loyalty\Api\Data\AppliedGiftCardInterface" type="Leat\Loyalty\Model\Data\AppliedGiftCard" />
    <preference for="Leat\Loyalty\Api\AppliedGiftCardRepositoryInterface" type="Leat\Loyalty\Model\AppliedGiftCardRepository" />
    <preference for="Leat\Loyalty\Api\Data\AppliedGiftCardSearchResultsInterface" type="Leat\Loyalty\Model\Data\AppliedGiftCardSearchResults" />
    <preference for="Leat\Loyalty\Api\Data\AppliedGiftCardDetailsInterface" type="Leat\Loyalty\Model\Data\AppliedGiftCardDetails" />
    <preference for="Leat\Loyalty\Api\Data\RemoveGiftCardResultInterface" type="Leat\Loyalty\Model\Data\RemoveGiftCardResult" />
    <preference for="Leat\Loyalty\Api\RemoveGiftCardInterface" type="Leat\Loyalty\Model\RemoveGiftCard" />
    <preference for="Leat\Loyalty\Api\GetAppliedGiftCardsInterface" type="Leat\Loyalty\Model\GetAppliedGiftCards" />

    <!-- Plugins for prepaid balance handling -->
    <type name="Magento\Sales\Api\OrderRepositoryInterface">
        <plugin name="leat_loyalty_load_balance_data" type="Leat\Loyalty\Plugin\OrderRepository\LoadLeatBalanceData" sortOrder="10" />
    </type>

    <type name="Magento\Quote\Api\CartRepositoryInterface">
        <plugin name="leat_loyalty_save_balance_data" type="Leat\Loyalty\Plugin\QuoteRepository\SaveLeatBalanceData" sortOrder="10" />
    </type>

    <type name="Magento\Config\Model\Config\TypePool">
        <arguments>
            <argument name="sensitive" xsi:type="array">
                <item name="leat/connection/personal_access_token" xsi:type="string">1</item>
            </argument>
        </arguments>
    </type>

    <!-- Register our custom salesrule action -->
    <type name="Magento\SalesRule\Model\Rule\Action\Discount\CalculatorFactory">
        <arguments>
            <argument name="discountRules" xsi:type="array">
                <item name="add_gift_products" xsi:type="string">Leat\Loyalty\Model\SalesRule\Action\AddGiftProducts</item>
            </argument>
        </arguments>
    </type>

    <!-- SalesRule Extension Attributes Plugin -->
    <type name="Magento\SalesRule\Api\RuleRepositoryInterface">
        <plugin name="leat_loyalty_salesrule_extension_attributes"
                type="Leat\Loyalty\Plugin\SalesRule\ExtensionAttributesPlugin"
                sortOrder="20" />
    </type>

    <!-- SalesRule Model Plugins -->
    <type name="Magento\SalesRule\Model\Rule">
        <plugin name="leat_loyalty_salesrule_model_save"
                type="Leat\Loyalty\Plugin\SalesRule\Model\RuleSavePlugin"
                sortOrder="10" />
        <plugin name="leat_loyalty_salesrule_model_load"
                type="Leat\Loyalty\Plugin\SalesRule\Model\RuleLoadPlugin"
                sortOrder="10" />
    </type>

    <!-- Cart Item Extension Attributes Plugin -->
    <type name="Magento\Quote\Api\CartItemRepositoryInterface">
        <plugin name="leat_loyalty_cart_item_extension_attributes"
                type="Leat\Loyalty\Plugin\Quote\CartItem\ExtensionAttributesPlugin"
                sortOrder="10" />
    </type>

    <!-- Automatically load extension attributes for quote items -->
    <type name="Magento\Quote\Model\Quote">
        <plugin name="leat_loyalty_load_item_extension_attributes"
                type="Leat\Loyalty\Plugin\Quote\LoadItemExtensionAttributesPlugin"
                sortOrder="10" />
        <plugin name="leat_loyalty_enforce_gift_item_quantities"
                type="Leat\Loyalty\Plugin\Quote\EnforceGiftItemQuantitiesPlugin"
                sortOrder="20" />
    </type>

    <!-- Prevent gift card items from being merged in cart -->
    <type name="Magento\Quote\Model\Quote\Item">
        <plugin name="leat_loyalty_prevent_giftcard_merge"
                type="Leat\Loyalty\Plugin\Quote\PreventGiftcardMergePlugin"
                sortOrder="10" />
    </type>

    <!-- Prevent merging giftcards by altering option comparison -->
    <type name="Magento\Quote\Model\Quote\Item\Compare">
        <plugin name="leat_loyalty_compare_giftcard_options"
                type="Leat\Loyalty\Plugin\Quote\Item\CompareOptionsPlugin"
                sortOrder="10" />
    </type>

    <!-- Save extension attributes when item ID becomes available -->
    <type name="Magento\Quote\Model\Quote\Item">
        <plugin name="leat_loyalty_save_item_extension_attributes"
                type="Leat\Loyalty\Plugin\Quote\Item\SaveExtensionAttributesPlugin"
                sortOrder="10" />
    </type>

    <!-- Transfer gift cards from quote to order after order placement -->
    <type name="Magento\Sales\Api\OrderManagementInterface">
        <plugin name="leat_loyalty_transfer_gift_cards_to_order"
                type="Leat\Loyalty\Plugin\OrderManagement\TransferGiftCardsToOrder"
                sortOrder="10" />
    </type>
</config>
